<template>
  <div>
    <v-toolbar app color="primary" dark>
      <BasketBadge />
      <v-spacer></v-spacer>
      <Logo />
    </v-toolbar>

    <v-container fluid grid-list-lg v-if="user.type === 'Reseller'">
      <ProfileHeader :hasRating="false" />
    </v-container>
    <v-container fluid grid-list-lg v-else-if="user.type === 'Customer'">
      <ProfileHeader />
      <div v-if="!user.resellerId" class="mt-2">
        No reseller yet.
        <a
          style="text-decoration: none;"
          @click="
            $router.push({ name: 'EditReseller', params: { action: 'add' } })
          "
          >Add one?</a
        >
      </div>
      <div v-else>
        <v-list two-line class="transparent" dense>
          <v-list-tile avatar ripple @click="viewReseller">
            <v-list-tile-avatar>
              <v-avatar v-if="user.resellerData.downloadURL" width="50px">
                <v-img
                  :src="user.resellerData.downloadURL"
                  class="flipped"
                  width="50"
                  contain
                ></v-img>
              </v-avatar>
              <v-avatar v-else width="50px">
                <v-img :src="MaleDefaultImage" width="50" contain></v-img>
              </v-avatar>
            </v-list-tile-avatar>
            <v-list-tile-content>
              <v-list-tile-sub-title>Your Reseller</v-list-tile-sub-title>
              <v-list-tile-title class="grey--text text--darken-2"
                >{{ user.resellerData.firstName }}
                {{ user.resellerData.middleInitial }}
                {{ user.resellerData.lastName }}</v-list-tile-title
              >
            </v-list-tile-content>
          </v-list-tile>
        </v-list>
        <v-dialog v-model="viewResellerData">
          <v-card>
            <v-container fluid grid-list-md>
              <div class="title grey--text text--darken-3 mb-3 text-xs-center">
                Agent ID {{ user.resellerData.agentId }}
              </div>
              <v-layout row wrap>
                <v-flex xs4>
                  <v-avatar
                    v-if="user.resellerData.downloadURL"
                    width="92px"
                    tile
                  >
                    <v-img
                      :src="user.resellerData.downloadURL"
                      class="flipped"
                    ></v-img>
                  </v-avatar>
                  <v-avatar v-else width="92px" tile>
                    <v-img :src="user.resellerData.placeholder"></v-img>
                  </v-avatar>
                </v-flex>
                <v-flex xs8>
                  <div class="body-2 mb-1 grey--text text--darken-3">
                    {{ user.resellerData.firstName }}
                    {{ user.resellerData.middleInitial }}
                    {{ user.resellerData.lastName }}
                  </div>
                  <p
                    class="grey--text"
                    v-if="!user.resellerData.isEmailAutogenerated"
                  >
                    <v-icon color="grey">mail</v-icon>
                    {{ user.resellerData.email }}
                  </p>
                  <p class="grey--text">
                    <v-icon color="grey">phone</v-icon>
                    {{ user.resellerData.contact }}
                  </p>
                  <p class="grey--text">
                    Member since {{ user.resellerData.createdAt | memberSince }}
                  </p>
                </v-flex>
              </v-layout>
            </v-container>
          </v-card>
        </v-dialog>
      </div>
    </v-container>

    <div
      class="px-3"
      v-if="user.type === 'Reseller' && user.status === 'pending'"
    >
      <v-alert border="right" outline type="info" value="true" elevation="2">
        Your application is under review - please check this page regularly to
        see if it has been approved.
      </v-alert>
    </div>

    <div
      class="px-3"
      v-else-if="user.type === 'Reseller' && user.status === 'denied'"
    >
      <v-alert border="right" outline type="error" value="true" elevation="2">
        Application was denied due to: {{ user.remarks }}
      </v-alert>
    </div>

    <div
      class="text-xs-center"
      v-if="user.type === 'Reseller' && user.status === 'denied'"
    >
      <v-btn
        depressed
        class="primary white--text"
        @click="ResubmitApplication"
        :loading="loading"
        :disabled="loading"
      >
        Resubmit Application <v-icon right>send</v-icon>
      </v-btn>
    </div>

    <v-list class="transparent">
      <v-list-tile
        avatar
        v-for="item in listByUserType"
        :key="item.name"
        @click="option(item.name)"
        ripple
      >
        <v-list-tile-action>
          <v-icon color="grey darken-1" v-text="item.icon"></v-icon>
        </v-list-tile-action>
        <v-list-tile-content>
          <v-list-tile-title
            class="grey--text text--darken-1"
            v-text="item.name"
          ></v-list-tile-title>
        </v-list-tile-content>
        <v-list-tile-action>
          <v-icon color="grey darken-1">keyboard_arrow_right</v-icon>
        </v-list-tile-action>
      </v-list-tile>
    </v-list>

    <TermsAndConditionsDialog ref="TermsAndConditionsDialog" />
    <DataPolicy ref="DataPolicy" />

    <BottomNav currentTab="more" />
    <Modal ref="modal" />
  </div>
</template>



<script>
import { mapGetters } from "vuex";
import { mixins } from "@/mixins";
import moment from "moment";
import ProfileHeader from "@/components/ProfileHeader";
import BasketBadge from "@/components/BasketBadge";
import Modal from "@/components/Modal";
import TermsAndConditionsDialog from "@/components/TermsAndConditionsDialog";
import DataPolicy from "@/components/DataPolicy";
import MaleDefaultImage from "@/assets/img/male-default.jpg";

export default {
  data: () => ({
    list: [
      {
        icon: "settings",
        name: "Settings",
        type: "Reseller",
        both: true
      },
      {
        icon: "help",
        name: "Support",
        type: "Reseller",
        both: true
      },
      {
        icon: "lock",
        name: "Data Privacy Policy",
        type: "Reseller",
        both: true
      },
      {
        icon: "format_list_bulleted",
        name: "Terms & Conditions",
        type: "Reseller",
        both: true
      },
      {
        icon: "exit_to_app",
        name: "Log out",
        type: "Reseller",
        both: true
      }
    ],
    viewResellerData: false,
    loading: false,
    MaleDefaultImage: MaleDefaultImage
  }),
  methods: {
    option(name) {
      if (name !== "Log out" && this.user.status === "pending") {
        this.$refs.modal.show(
          "Sorry",
          "Your application is under review - please check this page regularly to see if it has been approved."
        );
        return;
      }

      if (name === "Log out") {
        this.Indicator().open();
        this.$store.dispatch("accounts/LOG_OUT").then(() => {
          this.Indicator().close();
          this.$router.push({ name: "Home" });
        });
      } else if (name === "Settings") {
        this.$router.push({ name: "Settings" });
      } else if (name === "Contacts") {
        this.$router.push({ name: "Contacts" });
      } else if (name === "Support") {
        this.$router.push({ name: "Support" });
      } else if (name === "Data Privacy Policy") {
        this.$refs.DataPolicy.show();
      } else if (name === "Terms & Conditions") {
        this.$refs.TermsAndConditionsDialog.show();
      }
    },

    viewReseller() {
      this.viewResellerData = true;
    },

    goToMSA() {
      this.$router.push({ name: "MySellingAssistant" });
    },

    async ResubmitApplication() {
      // this.loading = true;
      // try {
      //   await this.$store.dispatch("accounts/RESUBMIT_STATUS");
      // } catch (error) {
      //   console.log(error);
      // }
      // this.loading = false;
      this.$router.push({ name: "EditProfile" });
    }
  },
  computed: {
    ...mapGetters("accounts", ["user"]),
    listByUserType() {
      return this.list.filter(l => l.type === this.user.type || l.both);
    }
  },
  filters: {
    memberSince(val) {
      return moment(val).format("MMMM D");
    }
  },
  components: {
    ProfileHeader,
    BasketBadge,
    Modal,
    TermsAndConditionsDialog,
    DataPolicy
  },
  mixins: [mixins]
};
</script>

<style scoped>
.star-icon {
  font-size: 18px;
}

.flipped {
  -webkit-transform: scaleX(-1);
  transform: scaleX(-1);
}
</style>
